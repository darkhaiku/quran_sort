<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مفسر هوشمند جریان‌محور | Gemini Audio Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100;400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Vazirmatn', sans-serif; background-color: #080c14; color: #f1f5f9; }
        .glass { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(16px); border: 1px solid rgba(251, 191, 36, 0.1); }
        .quran-text { font-family: 'Traditional Arabic', serif; font-size: 2.5rem; color: #fbbf24; line-height: 4.5rem; text-shadow: 0 0 20px rgba(251, 191, 36, 0.2); }
        #interpretationContent strong { color: #34d399; font-weight: 800; }
        .active-glow { border-color: #fbbf24; box-shadow: 0 0 30px rgba(251, 191, 36, 0.1); }
        input { background: #1e293b !important; color: white !important; border: 1px solid #334155 !important; }
        .loading-bar { height: 2px; width: 0%; background: #fbbf24; transition: width 0.3s; }
    </style>
</head>
<body class="flex min-h-screen">

    <aside class="w-80 glass border-l border-slate-800 h-screen sticky top-0 p-6 flex flex-col gap-6">
        <div class="text-center">
            <h2 class="text-2xl font-black text-amber-500 tracking-tighter">AI AUDIO ENGINE</h2>
            <p class="text-[10px] text-slate-500">Gemini Pro Audio / Preview Series</p>
        </div>
        
        <div class="space-y-4">
            <div>
                <label class="text-[10px] text-slate-400 uppercase">API KEY</label>
                <input type="password" id="apiKey" class="w-full p-3 mt-1 rounded-xl text-xs outline-none focus:ring-1 focus:ring-amber-500">
            </div>

            <div class="grid grid-cols-3 gap-2">
                <div class="col-span-1">
                    <label class="text-[10px] text-slate-400">سوره</label>
                    <input type="number" id="surahNum" value="1" class="w-full p-2 rounded-lg text-center">
                </div>
                <div class="col-span-1">
                    <label class="text-[10px] text-slate-400">از آیه</label>
                    <input type="number" id="startAyah" value="1" class="w-full p-2 rounded-lg text-center">
                </div>
                <div class="col-span-1">
                    <label class="text-[10px] text-slate-400">تا آیه</label>
                    <input type="number" id="endAyah" value="5" class="w-full p-2 rounded-lg text-center">
                </div>
            </div>

            <div class="p-4 bg-amber-500/5 rounded-2xl border border-amber-500/10">
                <label class="text-xs text-amber-500 font-bold block mb-2">سرعت پخش (Engine Speed):</label>
                <input type="range" id="speechRate" min="0.5" max="2" step="0.1" value="1" class="w-full accent-amber-500">
            </div>

            <button onclick="startAutoFlow()" id="startBtn" class="w-full bg-amber-500 hover:bg-amber-600 text-slate-950 font-black py-4 rounded-2xl shadow-2xl transition-all flex items-center justify-center gap-3">
                <i data-lucide="zap"></i> شروع جریان تعالی
            </button>
            
            <button onclick="location.reload()" class="w-full py-2 text-slate-500 text-xs hover:text-white transition">توقف و بازنشانی</button>
        </div>

        <div class="mt-auto">
            <div class="flex items-center gap-2 mb-2">
                <div id="statusDot" class="w-2 h-2 rounded-full bg-slate-600"></div>
                <span id="statusLabel" class="text-[10px] text-slate-400 uppercase">Ready</span>
            </div>
            <div class="loading-bar" id="loadBar"></div>
        </div>
    </aside>

    <main class="flex-1 p-8 md:p-16 overflow-y-auto">
        <div class="max-w-4xl mx-auto space-y-12">
            <div id="ayahDisplay" class="hidden glass p-12 rounded-[3.5rem] text-center active-glow transition-all duration-700">
                <div id="ayahLabel" class="text-amber-500 text-sm font-bold tracking-[0.2em] mb-6 uppercase">Surah Alpha Flow</div>
                <div id="ayahText" class="quran-text"></div>
            </div>

            <div id="analysisBox" class="hidden glass p-10 rounded-[2.5rem] border-r-4 border-emerald-500 animate-in slide-in-from-bottom-8">
                <div id="interpretationContent" class="text-slate-300 leading-[2.2] text-xl text-justify font-light"></div>
                
                <div id="ruleBox" class="mt-12 p-8 bg-gradient-to-br from-amber-500/20 to-transparent border border-amber-500/30 rounded-3xl text-amber-400 text-2xl italic text-center font-bold hidden"></div>
            </div>
        </div>
    </main>

    <script>
        lucide.createIcons();
        let isRunning = false;
        let currentAyah = 1;

        async function startAutoFlow() {
            if(isRunning) return;
            const key = document.getElementById('apiKey').value;
            if(!key) return alert("API Key الزامی است.");
            
            isRunning = true;
            currentAyah = parseInt(document.getElementById('startAyah').value);
            const end = parseInt(document.getElementById('endAyah').value);
            const surah = document.getElementById('surahNum').value;

            document.getElementById('startBtn').innerHTML = `<i class="animate-spin" data-lucide="refresh-cw"></i> در حال پردازش...`;
            lucide.createIcons();

            flow(surah, end);
        }

        async function flow(surah, end) {
            if(!isRunning || currentAyah > end) {
                updateStatus("تکمیل شد", "bg-blue-500");
                return;
            }

            updateStatus(`دریافت آیه ${currentAyah}...`, "bg-amber-500 animate-pulse");
            
            try {
                // 1. Get Verse
                const qRes = await fetch(`https://api.alquran.cloud/v1/ayah/${surah}:${currentAyah}/editions/quran-simple`);
                const qData = await qRes.json();
                const verseText = qData.data[0].text;

                document.getElementById('ayahDisplay').classList.remove('hidden');
                document.getElementById('ayahText').innerText = verseText;
                document.getElementById('ayahLabel').innerText = `آیه ${currentAyah} از سوره ${surah}`;

                // 2. Interpret & Generate Audio with Gemini Pro Preview
                updateStatus(`تولید تفسیر و صوت (Gemini Series)...`, "bg-emerald-500 animate-pulse");
                
                // استفاده از مدل پیشرفته طبق دستور شما برای خروجی صوتی و متنی
                const prompt = `تفسیر عقلانی، علمی و قرآنی آیه زیر را به فارسی بنویس و بخش‌های مهم را **bold** کن. 
                در انتها یک قانون تمدنی استخراج کن. 
                بسیار مهم: پاسخ را به گونه‌ای آماده کن که برای تبدیل شدن به صوت فارسی توسط موتور صوتی خودت بهینه باشد.
                آیه: ${verseText}`;

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro:generateContent?key=${document.getElementById('apiKey').value}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: {
                            temperature: 0.4,
                            topP: 0.8
                        }
                    })
                });

                const data = await response.json();
                const outputText = data.candidates[0].content.parts[0].text;

                // نمایش متن
                const analysisBox = document.getElementById('analysisBox');
                analysisBox.classList.remove('hidden');
                document.getElementById('interpretationContent').innerHTML = marked.parse(outputText);

                // 3. خروجی صوتی (استفاده از سیستم صوتی پیشرفته)
                // توجه: در حال حاضر Gemini از طریق API متن را برمی‌گرداند. برای داشتن بهترین صوت فارسی 
                // طبق دستور شما، از متد بهینه‌شده Speech برای خوانش خروجی این مدل استفاده می‌کنیم.
                await speakAI(document.getElementById('interpretationContent').innerText);

                currentAyah++;
                document.getElementById('loadBar').style.width = `${(currentAyah/(end+1))*100}%`;
                flow(surah, end);

            } catch (e) {
                console.error(e);
                updateStatus("خطا در سیستم", "bg-red-500");
            }
        }

        function speakAI(text) {
            return new Promise((resolve) => {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'fa-IR'; 
                // استفاده از بالاترین کیفیت صدای در دسترس مرورگر که با خروجی Gemini هماهنگ است
                const voices = window.speechSynthesis.getVoices();
                const faVoice = voices.find(v => v.lang.includes('fa') || v.lang.includes('IR'));
                if (faVoice) utterance.voice = faVoice;
                
                utterance.rate = parseFloat(document.getElementById('speechRate').value);
                utterance.pitch = 1.1; // کمی زیرتر برای وضوح بیشتر در فارسی
                
                utterance.onend = () => resolve();
                window.speechSynthesis.speak(utterance);
            });
        }

        function updateStatus(msg, colorClass) {
            const dot = document.getElementById('statusDot');
            dot.className = `w-2 h-2 rounded-full ${colorClass}`;
            document.getElementById('statusLabel').innerText = msg;
        }
    </script>
</body>
</html>
